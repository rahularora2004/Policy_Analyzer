import React, { useState } from 'react';

// --- Helper Functions & Constants ---

// Function to call the Gemini API with exponential backoff for retries
const callGeminiAPI = async (prompt, retries = 3, delay = 1000) => {
    const apiKey = ""; // Leave this as-is, Canvas will handle it
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{
            role: "user",
            parts: [{ text: prompt }]
        }],
        generationConfig: {
            temperature: 0.5,
            topK: 1,
            topP: 1,
        }
    };

    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                 // Throw an error if the response structure is unexpected
                throw new Error("Invalid response structure from API.");
            }

        } catch (error) {
            console.error(`Attempt ${i + 1} failed:`, error);
            if (i === retries - 1) {
                // If this was the last retry, re-throw the error
                throw error;
            }
            // Wait for the delay period before the next retry
            await new Promise(res => setTimeout(res, delay));
            // Double the delay for the next potential retry
            delay *= 2;
        }
    }
};


// --- UI Components ---

// Component for the header section
const Header = () => (
    <header className="bg-gray-900 text-white p-6 shadow-lg">
        <div className="container mx-auto text-center">
            <h1 className="text-4xl font-bold tracking-tight">AI Law & Policy Analyzer</h1>
            <p className="mt-2 text-lg text-gray-300">Transforming complex legal jargon into clear, understandable insights.</p>
        </div>
    </header>
);

// Component for the loading spinner
const LoadingSpinner = () => (
    <div className="flex flex-col items-center justify-center p-8">
        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500"></div>
        <p className="mt-4 text-gray-400">Analyzing document...</p>
    </div>
);

// Component to display error messages
const ErrorMessage = ({ message }) => (
    <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-md" role="alert">
        <p className="font-bold">An Error Occurred</p>
        <p>{message}</p>
    </div>
);

// Component to render the analysis result
const AnalysisResult = ({ result }) => (
    <div className="bg-white p-6 rounded-lg shadow-inner animate-fade-in">
        <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2 border-gray-200">Analysis Complete</h2>
        <div className="prose prose-lg max-w-none text-gray-700 whitespace-pre-wrap">
            {result}
        </div>
    </div>
);

// Component for the footer section
const Footer = () => (
    <footer className="bg-gray-900 text-white py-6 mt-12">
        <div className="container mx-auto text-center">
            <p className="text-gray-400 font-semibold">
                Portfolio Punchline: "Built an AI-powered tool that translates complex policies and court judgments into actionable, plain-language insights for citizens and researchers."
            </p>
            <p className="text-sm text-gray-500 mt-2">
                Powered by Google Gemini
            </p>
        </div>
    </footer>
);

// --- Main App Component ---

export default function App() {
    const [inputText, setInputText] = useState('');
    const [analysisResult, setAnalysisResult] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    // Handles the analysis process
    const handleAnalyze = async () => {
        if (!inputText.trim()) {
            setError("Please paste some legal text to analyze.");
            return;
        }

        setIsLoading(true);
        setError(null);
        setAnalysisResult('');

        // The prompt guides the AI to provide the desired output format
        const prompt = `
            Analyze the following legal or policy document. Your task is to act as a legal expert simplifying complex text for the general public.
            Provide a clear, plain-language summary. Break down the key points, explain the potential impact on citizens or relevant parties, and highlight any actionable items or important dates.
            Structure your output with clear headings.

            Here is the document:
            ---
            ${inputText}
            ---
        `;

        try {
            const result = await callGeminiAPI(prompt);
            setAnalysisResult(result);
        } catch (err) {
            console.error("Failed to get analysis from API:", err);
            setError("Sorry, we couldn't analyze the document. The server might be busy. Please try again later.");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 font-sans">
            <Header />

            <main className="container mx-auto p-4 sm:p-6 md:p-8">
                <div className="bg-white p-8 rounded-xl shadow-2xl max-w-4xl mx-auto">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-4">Enter Legal Text</h2>
                    <p className="text-gray-600 mb-6">
                        Paste the content of a bill, judgment, or policy document below. The AI will break it down for you.
                    </p>
                    
                    <textarea
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        placeholder="Paste your legal text here..."
                        className="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                        disabled={isLoading}
                    />

                    <div className="mt-6 text-center">
                        <button
                            onClick={handleAnalyze}
                            disabled={isLoading}
                            className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 shadow-lg"
                        >
                            {isLoading ? 'Analyzing...' : 'Analyze Text'}
                        </button>
                    </div>
                </div>

                <div className="max-w-4xl mx-auto mt-10">
                    {isLoading && <LoadingSpinner />}
                    {error && <ErrorMessage message={error} />}
                    {analysisResult && <AnalysisResult result={analysisResult} />}
                </div>
            </main>
            
            <Footer />
            
            <style>{`
              @keyframes fade-in {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
              }
              .animate-fade-in {
                animation: fade-in 0.5s ease-out forwards;
              }
              .prose h1, .prose h2, .prose h3 { color: #334155; }
              .prose strong { color: #475569; }
            `}</style>
        </div>
    );
}
